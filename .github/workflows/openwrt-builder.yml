name: ImmortalWrt Builder

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      target:
        description: 'Target device (e.g., x86_64, rockchip_armv8)'
        required: false
        default: 'x86_64'
      subtarget:
        description: 'Subtarget (e.g., generic, tiny)'
        required: false
        default: 'generic'
      profile:
        description: 'Device profile'
        required: false
        default: ''

env:
  REPO_URL: https://github.com/immortalwrt/immortalwrt
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        target: [${{ github.event.inputs.target || 'x86_64' }}]
        subtarget: [${{ github.event.inputs.subtarget || 'generic' }}]
        profile: [${{ github.event.inputs.profile || '' }}]

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          ccache \
          clang \
          curl \
          fakeroot \
          g++ \
          gawk \
          gcc \
          git \
          libncurses5-dev \
          libssl-dev \
          make \
          python3 \
          rsync \
          unzip \
          wget \
          xsltproc \
          zlib1g-dev
        df -h

    - name: Clone ImmortalWrt
      run: |
        git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
        cd openwrt
        git log -1 --oneline

    - name: Load Custom Feeds
      run: |
        if [ -f $FEEDS_CONF ]; then
          cp $FEEDS_CONF openwrt/feeds.conf.default
        fi
        if [ -f $DIY_P1_SH ]; then
          chmod +x $DIY_P1_SH
          cd openwrt
          ../$DIY_P1_SH
        fi

    - name: Update Feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Load Configuration
      run: |
        if [ -d files ]; then
          cp -r files openwrt/
        fi
        if [ -f $CONFIG_FILE ]; then
          cp $CONFIG_FILE openwrt/.config
        else
          cd openwrt
          # 生成默认配置
          TARGET_CONFIG=""
          if [ -n "${{ matrix.target }}" ] && [ -n "${{ matrix.subtarget }}" ]; then
            if [ -n "${{ matrix.profile }}" ]; then
              cat > .config << EOF
CONFIG_TARGET_${{ matrix.target }}=y
CONFIG_TARGET_${{ matrix.target }}_${{ matrix.subtarget }}=y
CONFIG_TARGET_${{ matrix.target }}_${{ matrix.subtarget }}_DEVICE_${{ matrix.profile }}=y
EOF
            else
              cat > .config << EOF
CONFIG_TARGET_${{ matrix.target }}=y
CONFIG_TARGET_${{ matrix.target }}_${{ matrix.subtarget }}=y
EOF
            fi
          fi
        fi
        if [ -f $DIY_P2_SH ]; then
          chmod +x $DIY_P2_SH
          cd openwrt
          ../$DIY_P2_SH
        fi

    - name: Apply Kernel Fixes
      run: |
        cd openwrt
        # 解决常见的编译问题
        if [ -d ../patches ]; then
          find ../patches -name "*.patch" -type f | while read patch; do
            echo "Applying patch: $patch"
            patch -p1 -i "$patch" || true
          done
        fi

    - name: Configure Build
      run: |
        cd openwrt
        make defconfig
        # 检查是否需要运行 menuconfig
        if [ ! -f .config ] || ! grep -q "CONFIG_TARGET" .config; then
          make menuconfig || true
        fi

    - name: Download Packages
      run: |
        cd openwrt
        make download -j$(nproc) || make download -j1
        # 重新下载失败的包
        make download -j1 V=s 2>&1 | grep -i "failed\|error" || true

    - name: Build Firmware
      run: |
        cd openwrt
        echo "Building with $(nproc) threads"
        make -j$(nproc) || make -j2 || make -j1 V=s
        
        # 获取设备名称
        DEVICE_NAME=$(grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' | head -1)
        if [ -z "$DEVICE_NAME" ]; then
          DEVICE_NAME=$(grep '^CONFIG_TARGET_BOARD=' .config | cut -d'=' -f2 | tr -d '"' | head -1)
        fi
        if [ -z "$DEVICE_NAME" ]; then
          DEVICE_NAME="${{ matrix.target }}-${{ matrix.subtarget }}"
        fi
        echo "DEVICE_NAME=${DEVICE_NAME}" >> $GITHUB_ENV
        echo "BUILD_DATE=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_ENV

    - name: Organize Firmware Files
      if: success()
      run: |
        cd openwrt/bin/targets/*/*
        FIRMWARE_DIR="ImmortalWrt_${DEVICE_NAME}_${BUILD_DATE}"
        mkdir -p "${FIRMWARE_DIR}"
        
        # 复制固件文件
        find . -maxdepth 1 -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" -o -name "*.rootfs" \) \
          -exec cp {} "${FIRMWARE_DIR}/" \;
        
        # 复制配置文件
        if [ -f ../../../.config ]; then
          cp ../../../.config "${FIRMWARE_DIR}/config.buildinfo"
        fi
        
        # 创建SHA256校验文件
        cd "${FIRMWARE_DIR}"
        sha256sum * > sha256sums.txt
        
        echo "FIRMWARE_PATH=${PWD}" >> $GITHUB_ENV
        echo "RELEASE_NAME=ImmortalWrt-${DEVICE_NAME}-${BUILD_DATE}" >> $GITHUB_ENV

    - name: Upload Firmware Artifacts
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: ${{ env.RELEASE_NAME }}
        path: ${{ env.FIRMWARE_PATH }}
        retention-days: 7

    - name: Create Release
      uses: softprops/action-gh-release@v2
      if: success() && env.UPLOAD_RELEASE == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ env.RELEASE_NAME }}
        name: ImmortalWrt ${{ env.DEVICE_NAME }} (${{ env.BUILD_DATE }})
        body: |
          # ImmortalWrt Build
          
          **Device:** ${{ env.DEVICE_NAME }}
          **Build Date:** ${{ env.BUILD_DATE }}
          **Target:** ${{ matrix.target }}/${{ matrix.subtarget }}
          
          ## Firmware Files
          
          SHA256 checksums included in sha256sums.txt
          
          ## How to Use
          
          1. Download the appropriate firmware for your device
          2. Flash via recovery mode or SSH
          3. Default IP: 192.168.1.1
          4. Default username: root (no password)
          
          ## Source
          
          Built from [ImmortalWrt](https://github.com/immortalwrt/immortalwrt)
          
          **Note:** Custom configurations may have been applied.
        files: ${{ env.FIRMWARE_PATH }}/*
        draft: false
        prerelease: false

    - name: Cleanup Old Releases
      uses: dev-drprasad/delete-older-releases@v0.2.0
      if: success() && env.UPLOAD_RELEASE == 'true'
      with:
        keep_latest: 5
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
