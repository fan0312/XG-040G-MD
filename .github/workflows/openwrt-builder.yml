#
# https://github.com/P3TERX/Actions-OpenWrt
#
# File: .github/workflows/openwrt-bulder.yml
# Description: Build OpenWrt using GitHub Actions
#
# Copyright (c) 2019-2024 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#

name: OpenWrt Builder

on:
  repository_dispatch:
  workflow_dispatch:

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-24.04  # ä½¿ç”¨ Ubuntu 24.04 LTS

    steps:
    # ========== æ­¥éª¤1: æ£€å‡ºä»£ç  ==========
    - name: Checkout source code
      uses: actions/checkout@v4  # ä½¿ç”¨ v4 ç‰ˆæœ¬

    # ========== æ­¥éª¤2: åˆå§‹åŒ–ç¯å¢ƒ ==========
    - name: Initialize build environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        # æ¸…ç†ç³»ç»Ÿç©ºé—´
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
        sudo docker image prune --all --force
        
        # æ›´æ–°åŒ…åˆ—è¡¨
        sudo -E apt-get -qq update
        
        # å®‰è£… OpenWrt ç¼–è¯‘æ‰€éœ€ä¾èµ–
        sudo -E apt-get -qq install \
          ack antlr3 asciidoc autoconf automake autopoint binutils bison \
          build-essential bzip2 ccache cmake cpio curl device-tree-compiler \
          fastjar flex gawk gettext gcc-multilib g++-multilib git gperf \
          haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev \
          libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev \
          libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev \
          libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full \
          patch pkgconf python3 python3-pyelftools python3-setuptools \
          python3-pip python3-venv qemu-utils rsync scons squashfs-tools \
          subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd \
          zlib1g-dev libyaml-dev libxml2-dev libxslt1-dev libffi-dev \
          libbz2-dev liblzma-dev libsqlite3-dev
        
        # æ¸…ç†æ— ç”¨åŒ…
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        
        # è®¾ç½®æ—¶åŒº
        sudo timedatectl set-timezone "$TZ"
        
        # åˆ›å»ºå·¥ä½œç›®å½•
        sudo mkdir -p /workdir
        sudo chown $USER:$GROUPS /workdir

    # ========== æ­¥éª¤3: å…‹éš† OpenWrt æºç  ==========
    - name: Clone OpenWrt source code
      working-directory: /workdir
      run: |
        # æ˜¾ç¤ºç£ç›˜ç©ºé—´ä¿¡æ¯
        df -hT $PWD
        
        # å…‹éš†æºç ä»“åº“
        git clone $REPO_URL -b $REPO_BRANCH openwrt
        
        # åˆ›å»ºç¬¦å·é“¾æ¥åˆ°å·¥ä½œç©ºé—´
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

    # ========== æ­¥éª¤4: åº”ç”¨ airoha_eth.c è¡¥ä¸ ==========
    - name: Apply kernel patch for airoha_eth.c
      working-directory: /workdir/openwrt
      run: |
        echo "æ­£åœ¨ä¿®å¤ airoha_eth.c ç¼–è¯‘é”™è¯¯..."
        
        # åˆ›å»ºè¡¥ä¸ç›®å½•
        mkdir -p target/linux/airoha/patches-6.6
        
        # åˆ›å»ºä¿®å¤è¡¥ä¸
        cat > target/linux/airoha/patches-6.6/999-fix-alloc_netdev_dummy.patch << 'EOF'
From: GitHub Actions Fix
Date: $(date +'%Y-%m-%d')
Subject: [PATCH] fix airoha_eth.c: replace alloc_netdev_dummy with alloc_netdev_mqs

ä¿®å¤ç¼–è¯‘é”™è¯¯ï¼šalloc_netdev_dummy() å‡½æ•°åœ¨æ–°å†…æ ¸ä¸­å·²ç§»é™¤ã€‚
ä½¿ç”¨ alloc_netdev_mqs() æ›¿ä»£ã€‚

Signed-off-by: GitHub Actions

---
 drivers/net/ethernet/mediatek/airoha_eth.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/drivers/net/ethernet/mediatek/airoha_eth.c b/drivers/net/ethernet/mediatek/airoha_eth.c
index xxxxxxx..xxxxxxx 100644
--- a/drivers/net/ethernet/mediatek/airoha_eth.c
+++ b/drivers/net/ethernet/mediatek/airoha_eth.c
@@ -3258,7 +3258,7 @@ static int airoha_probe(struct platform_device *pdev)
        eth->features = features;
        eth->soc_data = soc_data;
 
-       eth->napi_dev = alloc_netdev_dummy(0);
+       eth->napi_dev = alloc_netdev_mqs(0, "dummy%d", NET_NAME_UNKNOWN, ether_setup, 1, 1);
        if (!eth->napi_dev) {
-               dev_err(&pdev->dev, "alloc_netdev_dummy failed\n");
+               dev_err(&pdev->dev, "alloc_netdev_mqs failed\n");
                ret = -ENOMEM;
EOF
        
        echo "âœ… è¡¥ä¸å·²åˆ›å»ºï¼štarget/linux/airoha/patches-6.6/999-fix-alloc_netdev_dummy.patch"

    # ========== æ­¥éª¤5: åŠ è½½è‡ªå®šä¹‰ feeds ==========
    - name: Load custom feeds configuration
      run: |
        # å¦‚æœå­˜åœ¨ feeds.conf.defaultï¼Œå¤åˆ¶åˆ° openwrt ç›®å½•
        [ -e $FEEDS_CONF ] && mv $FEEDS_CONF openwrt/feeds.conf.default
        
        # å¦‚æœå­˜åœ¨ diy-part1.shï¼Œæ‰§è¡Œå®ƒ
        if [ -f "$DIY_P1_SH" ]; then
          chmod +x $DIY_P1_SH
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P1_SH
        fi

    # ========== æ­¥éª¤6: æ›´æ–° feeds ==========
    - name: Update package feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a

    # ========== æ­¥éª¤7: å®‰è£… feeds ==========
    - name: Install package feeds
      run: |
        cd openwrt
        ./scripts/feeds install -a

    # ========== æ­¥éª¤8: åŠ è½½è‡ªå®šä¹‰é…ç½® ==========
    - name: Load custom build configuration
      run: |
        # å¤åˆ¶è‡ªå®šä¹‰æ–‡ä»¶
        [ -e files ] && mv files openwrt/files
        [ -e $CONFIG_FILE ] && mv $CONFIG_FILE openwrt/.config
        
        # æ‰§è¡Œ diy-part2.shï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -f "$DIY_P2_SH" ]; then
          chmod +x $DIY_P2_SH
          cd openwrt
          $GITHUB_WORKSPACE/$DIY_P2_SH
        fi

    # ========== æ­¥éª¤9: ä¸‹è½½è½¯ä»¶åŒ… ==========
    - name: Download required packages
      id: package
      run: |
        cd openwrt
        
        # ç”Ÿæˆé»˜è®¤é…ç½®
        make defconfig
        
        # å¹¶è¡Œä¸‹è½½è½¯ä»¶åŒ…
        make download -j$(nproc)
        
        # æ£€æŸ¥å’Œæ¸…ç†æ— æ•ˆçš„å°æ–‡ä»¶
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;

    # ========== æ­¥éª¤10: ç¼–è¯‘å›ºä»¶ ==========
    - name: Compile the firmware
      id: compile
      run: |
        cd openwrt
        
        echo "ğŸš€ å¼€å§‹ç¼–è¯‘ï¼Œä½¿ç”¨ $(nproc) ä¸ªçº¿ç¨‹..."
        
        # è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
        export FORCE_UNSAFE_CONFIGURE=1
        export CCACHE_DIR="/tmp/ccache"
        export CCACHE_MAXSIZE="2G"
        mkdir -p $CCACHE_DIR
        
        # ä¸‰é˜¶æ®µç¼–è¯‘ç­–ç•¥
        if make -j$(nproc) ; then
          echo "âœ… å¤šçº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
          echo "status=success" >> $GITHUB_OUTPUT
        elif make -j1 ; then
          echo "âš ï¸  å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "ğŸ” ç¼–è¯‘å¤±è´¥ï¼Œå¯ç”¨è¯¦ç»†æ¨¡å¼..."
          make -j1 V=s
          echo "status=success" >> $GITHUB_OUTPUT
        fi
        
        # æå–è®¾å¤‡åç§°
        grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
        
        # è®¾ç½®ç¯å¢ƒå˜é‡
        [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    # ========== æ­¥éª¤11: æ£€æŸ¥ç£ç›˜ç©ºé—´ ==========
    - name: Check disk space usage
      if: (!cancelled())
      run: df -hT

    # ========== æ­¥éª¤12: ä¸Šä¼  bin ç›®å½•ï¼ˆå¯é€‰ï¼‰ ==========
    - name: Upload bin directory as artifact
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: openwrt/bin
        retention-days: 7  # ä¿ç•™7å¤©

    # ========== æ­¥éª¤13: æ•´ç†å›ºä»¶æ–‡ä»¶ ==========
    - name: Organize firmware files
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd openwrt/bin/targets/*/*
        
        # æ¸…ç†ä¸å¿…è¦çš„ packages ç›®å½•
        rm -rf packages
        
        # è®¾ç½®å›ºä»¶è·¯å¾„ç¯å¢ƒå˜é‡
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    # ========== æ­¥éª¤14: ä¸Šä¼ å›ºä»¶ä½œä¸º artifact ==========
    - name: Upload firmware directory as artifact
      if: steps.organize.outputs.status == 'success' && !cancelled()
      uses: actions/upload-artifact@v4
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}
        retention-days: 7

    # ========== æ­¥éª¤15: ç”Ÿæˆå‘å¸ƒæ ‡ç­¾ ==========
    - name: Generate release tag
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        # ç”Ÿæˆæ—¶é—´æˆ³æ ‡ç­¾
        release_tag="$(date +"%Y.%m.%d-%H%M")"
        echo "release_tag=$release_tag" >> $GITHUB_OUTPUT
        
        # åˆ›å»ºå‘å¸ƒè¯´æ˜
        cat > release.txt << EOF
        # OpenWrt Firmware Release
        
        ## ğŸ“… Build Information
        - **Build Date**: $(date +"%Y-%m-%d %H:%M:%S")
        - **GitHub Actions Run**: ${{ github.run_id }}
        - **Source Repository**: ${{ env.REPO_URL }}
        - **Branch**: ${{ env.REPO_BRANCH }}
        - **Host OS**: Ubuntu 24.04 LTS
        - **Architecture**: $(uname -m)
        
        ## ğŸš€ Usage
        1. Flash the firmware to your router
        2. Default IP Address: **192.168.1.1**
        3. Default Username: **root** (no password by default)
        
        ## ğŸ“‹ Notes
        - This firmware is built using GitHub Actions
        - Includes custom patches and configurations
        - Built for: ${{ env.DEVICE_NAME }}
        
        ## ğŸ”§ Build Tools
        - $(gcc --version | head -n1)
        - $(make --version | head -n1)
        EOF
        
        echo "status=success" >> $GITHUB_OUTPUT

    # ========== æ­¥éª¤16: å‘å¸ƒåˆ° GitHub Releases ==========
    - name: Upload firmware to GitHub Releases
      if: steps.tag.outputs.status == 'success' && !cancelled()
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*
        draft: false
        prerelease: false
        generate_release_notes: true

    # ========== æ­¥éª¤17: æ¸…ç†æ—§çš„ workflow runs ==========
    - name: Clean up old workflow runs
      uses: Mattraks/delete-workflow-runs@v2
      with:
        retain_days: 0
        keep_minimum_runs: 2

    # ========== æ­¥éª¤18: æ¸…ç†æ—§çš„ Releases ==========
    - name: Clean up old releases
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        # ä½¿ç”¨ GitHub CLI åˆ é™¤æ—§çš„ releases
        echo "å®‰è£… GitHub CLI..."
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
        sudo apt update
        sudo apt install gh -y
        
        echo "é…ç½® GitHub CLI..."
        echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
        
        echo "è·å– releases åˆ—è¡¨..."
        releases=$(gh api repos/${{ github.repository }}/releases --jq '.[] | select(.draft == false) | .tag_name' | sort -Vr)
        
        echo "å½“å‰ releases:"
        echo "$releases"
        
        # ä¿ç•™æœ€æ–°çš„3ä¸ª releases
        keep=3
        count=0
        echo "$releases" | while read tag; do
          count=$((count + 1))
          if [ $count -gt $keep ]; then
            echo "åˆ é™¤æ—§çš„ release: $tag"
            gh api -X DELETE repos/${{ github.repository }}/releases/tags/$tag
            gh api -X DELETE repos/${{ github.repository }}/git/refs/tags/$tag
          fi
        done
        
        echo "âœ… æ¸…ç†å®Œæˆï¼Œä¿ç•™æœ€æ–°çš„ $keep ä¸ª releases"
